# Keyvault with an Autogenerated Password.


## Overview
This Bicep script deploys a Key Vault with an autogenerated password. The deployment script will initially generate a unique 16-character secret and store it in the Key Vault. After the secret is generated and stored, the deployment script is deleted to ensure security (left over output secrets in the script) rather than wait for the retention interval 1hour.

For any further deployments, the deployment script checks if a secret allready exists, if it does it outputs both the newSecret and existingSecret, the keyvault then performs a conditional deployment logic as follows.

1. If the existingSecret is empty deploys the newSecret.
2. If the existingSecret has a value an empty array is used '[]' result is no update. 
3. Any additional secrets are deployed as normal with no condition logic associated 'testOtherSecret'. 

## Script Details

### Target Scope
The target scope for this deployment is the subscription level.

### Parameters used

```bicep
// Required parameters
@description('Required. Location for the deployment')
param location string = '<location>'
@description('Rquired. Deploying user principle id for RBAC access to the keyvault')
param deployUserPrincipleId string = '<deployUserPrincipleId>'

// Optional parameters
@description('Optional. Resource group name.')
param resourceGroupName string = 'rg-deployment-script'
@description('Optional. User assigned identity name')
param userAssignedIdentityName string = 'uami-shared'
@description('Optional. Keyvault name')
param keyVaultName string = 'kv-shared-01'
@description('Optional. Secret name')
param secretName string = 'adminPasswordKvSecret'
@description('Optional. Deployment Script name that generates the secret')
param scriptName string = 'generatePasswordKvSecret'
@description('Optional. Deployment Script name to delete the generatePasswordKvSecret script')
param deleteScriptName string = 'deletedGeneratePasswordKvSecret'
@description('Optional. UTC time value used to generate the secret')
param utcValue string = utcNow()
```

### Resources

#### 1. Shared Resource Group
This is the resource group where all resources will be deployed.

```bicep
@description('This is the deployment script and shared keyvault resource group')
resource sharedResourceGroup 'Microsoft.Resources/resourceGroups@2021-01-01' = {
  name: resourceGroupName
  location: location
}
```

#### 2. User Assigned Identity
This is a user-assigned managed identity used by the deployment scripts.

```bicep
@description('Deployment Script User assigned identity')
module userAssignedIdentity 'br/public:avm/res/managed-identity/user-assigned-identity:0.4.0' = {
  scope: sharedResourceGroup
  name: 'userAssignedIdentity-deploy'
  params: {
    name: userAssignedIdentityName
  }
}
```

#### 3. Deployment Script to Generate Secret
This script generates a unique 16-character secret and stores it in the Key Vault.

```bicep
@description('Deployment Script to generate a unique 16 character secret to paas to keyvault')
module deploymentScript 'br/public:avm/res/resources/deployment-script:0.5.1' = {
  name: 'deploymentScript-deploy'
  scope: sharedResourceGroup
  params: {
    name: scriptName
    managedIdentities: {
      userAssignedResourceIds: [
        userAssignedIdentity.outputs.resourceId
      ]
    }
    kind: 'AzurePowerShell'
    baseTime: utcValue
    azPowerShellVersion: '12.3'
    environmentVariables: [
      {
        name: 'varKeyVaultName'
        value: keyVaultName
      }
      {
        name: 'varSecretName'
        value: secretName
      }
    ]
    scriptContent: '''
    # Check for an existing secret value to be recorded as an output 'existingSecret'
    $existingSecret = Get-AzKeyVaultSecret -VaultName $env:varKeyVaultName -Name $env:varSecretName -AsPlainText -ErrorAction SilentlyContinue

    # Generate a new secret value to be recorded as an output 'newSecret'
    $charlist = [char]94..[char]126 + [char]65..[char]90 + [char]47..[char]57
    $newSecret = ($charlist | Get-Random -count 16) -join ''

    # Define the deployment script outputs
    $DeploymentScriptOutputs = @{
      "newSecret" = $newSecret
      "existingSecret" = $existingSecret
    }
    '''
    timeout: 'PT1H'
    retentionInterval: 'PT1H'
    roleAssignments: [
      {
        description: 'Allow the user assigned identity to delete this script see deletedGeneratePasswordKvSecret script'
        principalId: userAssignedIdentity.outputs.principalId
        principalType: 'ServicePrincipal'
        roleDefinitionIdOrName: 'Contributor'
      }
    ]
  }
}
```

**PowerShell Content Explanation:**

- **Check for Existing Secret**: The script checks if a secret with the specified name already exists in the Key Vault.
- **Generate New Secret**: The script also generates a new 16-character secret.
- **Define Outputs**: The script defines the outputs, including the new secret and any existing secret.

```powershell
# Check for an existing secret value to be recorded as an output 'existingSecret'
$existingSecret = Get-AzKeyVaultSecret -VaultName $env:varKeyVaultName -Name $env:varSecretName -AsPlainText -ErrorAction SilentlyContinue

# Generate a new secret value to be recorded as an output 'newSecret'
$charlist = [char]94..[char]126 + [char]65..[char]90 + [char]47..[char]57
$newSecret = ($charlist | Get-Random -count 16) -join ''

# Define the deployment script outputs
$DeploymentScriptOutputs = @{
  "newSecret" = $newSecret
  "existingSecret" = $existingSecret
}
```
#### 4. Key Vault to Store the Secret
This is the Key Vault where the generated secret is stored.

```bicep
@description('Keyvault to store the secret that was generated by the deployment script')
module keyvault 'br/public:avm/res/key-vault/vault:0.11.1' = {
  name: 'keyVault-deploy'
  scope: sharedResourceGroup
  params: {
    enablePurgeProtection: false
    name: keyVaultName
    sku: 'standard'
    accessPolicies: []
    secrets: concat(
      empty(deploymentScript.outputs.outputs.existingSecret ?? '') ? [
        {
          name: secretName
          value: deploymentScript.outputs.outputs.newSecret
        }
      ] : [],
      [
        {
          name: 'testOtherSecret'
          value: 'notARealSecret'
        }
      ]
    )
    roleAssignments: [
      {
        description: 'Allow the deploying user assigned identity to manage the key vault'
        principalId: deployUserPrincipleId
        principalType: 'User'
        roleDefinitionIdOrName: 'Key Vault Administrator'
      }
      {
        description: 'Allow the deployment script user assigned identity to manage the key vault'
        principalId: userAssignedIdentity.outputs.principalId
        principalType: 'ServicePrincipal'
        roleDefinitionIdOrName: 'Key Vault Administrator'
      }
    ]
  }
}
```

**Conditional Deployment of Secrets:**

1. If the existingSecret is empty deploys the newSecret.
2. If the existingSecret has a value and empty array is used '[]' result is no update. 
3. Any additional secrets are deployed as normal with no condition logic associated 'testOtherSecret'.  


```bicep
secrets: concat(
  empty(deploymentScript.outputs.outputs.existingSecret ?? '') ? [
    {
      name: secretName
      value: deploymentScript.outputs.outputs.newSecret
    }
  ] : [],
  [
    {
      name: 'testOtherSecret'
      value: 'notARealSecret'
    }
  ]
)
```

#### 5. Deployment Script to Delete the Generate Secret Script

This script deletes the generatePasswordKvSecret script and its outputs. This will be removed after the retentionInterval 1Hour (PT1H)

```bicep
@description('Deployment Script to delete generatePasswordKvSecret and its outputs. This scripts deletes after 1h of creation')
module deleteDeploymentScript 'br/public:avm/res/resources/deployment-script:0.5.1' = {
  name: 'deleteDeploymentScript-deploy'
  scope: sharedResourceGroup
  dependsOn: [
    deploymentScript
    keyvault
  ]
  params: {
    name: deleteScriptName
    managedIdentities: {
      userAssignedResourceIds: [
        userAssignedIdentity.outputs.resourceId
      ]
    }
    kind: 'AzurePowerShell'
    baseTime: utcValue
    azPowerShellVersion: '12.3'
    environmentVariables: [
      {
        name: 'varResourceGroupName'
        value: resourceGroupName
      }
      {
        name: 'varScriptName'
        value: scriptName
      }
    ]
    scriptContent: '''
    Remove-AzDeploymentScript -ResourceGroupName $env:varResourceGroupName -Name $env:varScriptName
    '''
    timeout: 'PT1H'
    retentionInterval: 'PT1H'
  }
}
```

**PowerShell Content Explanation:**

- The script removes the deployment script that generated the secret, ensuring that the script and its outputs are deleted after 1 hour.

```powershell
Remove-AzDeploymentScript -ResourceGroupName $env:varResourceGroupName -Name $env:varScriptName
```

### Example deployment usage

- Use the following inside or outside of the same script using the existing keyvault resource
- Define the keyvault as an existing resource

```bicep
@description('This is existing Keyvault resource for VM deployment')
resource keyVaultExisting 'Microsoft.KeyVault/vaults@2019-09-01' existing = {
  name: keyVaultName
  scope: sharedResourceGroup
}
```

Referance the existing keyvault and the secret name using 'getSecret' function.

```bicep
@description('Example usage of the keyvault secret for VM deployment')
module virtualMachine 'br/public:avm/res/compute/virtual-machine:0.11.0' = {
  name: 'virtualMachineDeployment'
  scope: sharedResourceGroup
  params: {
    // Required parameters
    adminUsername: 'localAdminUser'
    // Call the keyvault secret based on the secretName and existing keyvault resource. 
    adminPassword: keyVaultExisting.getSecret(secretName)
    imageReference: {
      offer: 'WindowsServer'
      publisher: 'MicrosoftWindowsServer'
      sku: '2022-datacenter-azure-edition'
      version: 'latest'
    }
    name: 'cvmwinmin'
    nicConfigurations: [
      {
        ipConfigurations: [
          {
            name: 'ipconfig01'
            subnetResourceId: '<subnetResourceId>'
          }
        ]
        nicSuffix: '-nic-01'
      }
    ]
    osDisk: {
      caching: 'ReadWrite'
      diskSizeGB: 128
      managedDisk: {
        storageAccountType: 'Premium_LRS'
      }
    }
    osType: 'Windows'
    vmSize: 'Standard_D2s_v3'
    zone: 0
  }
}
```
