# Keyvault with an Autogenerated Password.

## Metadata
- **Title**: Keyvault with an Autogenerated Password
- **Author**: Darren Frowen
- **Date Created**: 16-01-2025
- **Version**: 0.0.1
- **Description**: This script deploys a keyvault with an autogenerated password and then deletes the deployment script.

## Overview
This Bicep script deploys a Key Vault with an autogenerated password. The deployment script will initially generate a unique 16-character secret and store it in the Key Vault. After the secret is generated and stored, the deployment script is deleted to ensure security and clean up resources. Any further deployments the deployment scripts checks if a secret allready exists, if it does it outputs both the newSecret and existingSecret, the keyvault then performs a conditional deployment of the secret only if the existingSecret is an empty value hence maintaining the idopotency of the secret. 

## Script Details

### Target Scope
The target scope for this deployment is the subscription level.

### Parameters
- **resourceGroupName**: The name of the resource group.
- **userAssignedIdentityName**: The name of the user-assigned identity.
- **location**: The location for the resources.
- **keyVaultName**: The name of the Key Vault.
- **secretName**: The name of the secret to be stored in the Key Vault.
- **scriptName**: The name of the deployment script that generates the secret.
- **deleteScriptName**: The name of the deployment script that deletes the generatePasswordKvSecret script.
- **utcValue**: The UTC time value used to generate the secret.

### Resources

#### 1. Shared Resource Group
This is the resource group where all resources will be deployed.

```bicep
@description('This is the deployment script and shared keyvault resource group')
resource sharedResourceGroup 'Microsoft.Resources/resourceGroups@2021-01-01' = {
  name: resourceGroupName
  location: location
}
```

#### 2. User Assigned Identity
This is a user-assigned managed identity used by the deployment scripts.

```bicep
@description('Deployment Script User assigned identity')
module userAssignedIdentity 'br/public:avm/res/managed-identity/user-assigned-identity:0.4.0' = {
  scope: sharedResourceGroup
  name: 'userAssignedIdentity-deploy'
  params: {
    name: userAssignedIdentityName
  }
}
```

#### 3. Deployment Script to Generate Secret
This script generates a unique 16-character secret and stores it in the Key Vault.

```bicep
@description('Deployment Script to generate a unique 16 character secret to paas to keyvault')
module deploymentScript 'br/public:avm/res/resources/deployment-script:0.5.1' = {
  name: 'deploymentScript-deploy'
  scope: sharedResourceGroup
  params: {
    name: scriptName
    managedIdentities: {
      userAssignedResourceIds: [
        userAssignedIdentity.outputs.resourceId
      ]
    }
    kind: 'AzurePowerShell'
    baseTime: utcValue
    azPowerShellVersion: '12.3'
    environmentVariables: [
      {
        name: 'varKeyVaultName'
        value: keyVaultName
      }
      {
        name: 'varSecretName'
        value: secretName
      }
      {
        name: 'varResourceGroupName'
        value: resourceGroupName
      }
      {
        name: 'varScriptName'
        value: scriptName
      }
    ]
    scriptContent: '''
    # Check for an existing secret value to be recorded as an output 'existingSecret'
    $existingSecret = Get-AzKeyVaultSecret -VaultName $env:varKeyVaultName -Name $env:varSecretName -AsPlainText -ErrorAction SilentlyContinue

    # Generate a new secret value to be recorded as an output 'newSecret'
    $charlist = [char]94..[char]126 + [char]65..[char]90 + [char]47..[char]57
    $newSecret = ($charlist | Get-Random -count 16) -join ''

    # Define the deployment script outputs
    $DeploymentScriptOutputs = @{
      "newSecret" = $newSecret
      "existingSecret" = $existingSecret
    }
    '''
    timeout: 'PT1H'
    retentionInterval: 'PT1H'
    roleAssignments: [
      {
        description: 'Allow the user assigned identity to delete this script see deletedGeneratePasswordKvSecret script'
        principalId: userAssignedIdentity.outputs.principalId
        principalType: 'ServicePrincipal'
        roleDefinitionIdOrName: 'Contributor'
      }
    ]
  }
}
```

**PowerShell Content Explanation:**

```powershell
# Check for an existing secret value to be recorded as an output 'existingSecret'
$existingSecret = Get-AzKeyVaultSecret -VaultName $env:varKeyVaultName -Name $env:varSecretName -AsPlainText -ErrorAction SilentlyContinue

# Generate a new secret value to be recorded as an output 'newSecret'
$charlist = [char]94..[char]126 + [char]65..[char]90 + [char]47..[char]57
$newSecret = ($charlist | Get-Random -count 16) -join ''

# Define the deployment script outputs
$DeploymentScriptOutputs = @{
  "newSecret" = $newSecret
  "existingSecret" = $existingSecret
}
```

- **Check for Existing Secret**: The script checks if a secret with the specified name already exists in the Key Vault.
- **Generate New Secret**: The script also generates a new 16-character secret.
- **Define Outputs**: The script defines the outputs, including the new secret and any existing secret.

#### 4. Key Vault to Store the Secret
This is the Key Vault where the generated secret is stored.

```bicep
@description('Keyvault to store the secret that was generated by the deployment script')
module keyvault 'br/public:avm/res/key-vault/vault:0.11.1' = {
  name: 'keyVault-deploy'
  scope: sharedResourceGroup
  params: {
    enablePurgeProtection: false
    name: keyVaultName
    sku: 'standard'
    accessPolicies: []
    secrets: concat(
      empty(deploymentScript.outputs.outputs.existingSecret ?? '') ? [
        {
          name: secretName
          value: deploymentScript.outputs.outputs.newSecret
        }
      ] : [],
      [
        {
          name: 'testOtherSecret'
          value: 'notARealSecret'
        }
      ]
    )
    roleAssignments: [
      {
        description: 'Allow the deploying user assigned identity to manage the key vault'
        principalId: '0f32888d-7ae1-4643-a938-97d42a723c7c'
        principalType: 'User'
        roleDefinitionIdOrName: 'Key Vault Administrator'
      }
      {
        description: 'Allow the deployment script user assigned identity to manage the key vault'
        principalId: userAssignedIdentity.outputs.principalId
        principalType: 'ServicePrincipal'
        roleDefinitionIdOrName: 'Key Vault Administrator'
      }
    ]
  }
}
```

**Conditional Deployment of Secrets:**

```bicep
secrets: concat(
  empty(deploymentScript.outputs.outputs.existingSecret ?? '') ? [
    {
      name: secretName
      value: deploymentScript.outputs.outputs.newSecret
    }
  ] : [],
  [
    {
      name: 'testOtherSecret'
      value: 'notARealSecret'
    }
  ]
)
```

**Conditional Deployment**: 

- The script checks if an existing secret is present. 
- If an existing secret is present an empty [] secret object is used to ensure the existing secret is not changed. 
- If an existing secret is not present the new secret generated by the deployment script is configured.

#### 5. Deployment Script to Delete the Generate Secret Script
This script deletes the generatePasswordKvSecret script and its outputs.

```bicep
@description('Deployment Script to delete generatePasswordKvSecret and its outputs. This scripts deletes after 1h of creation')
module deleteDeploymentScript 'br/public:avm/res/resources/deployment-script:0.5.1' = {
  name: 'deleteDeploymentScript-deploy'
  scope: sharedResourceGroup
  dependsOn: [
    deploymentScript
    keyvault
  ]
  params: {
    name: deleteScriptName
    managedIdentities: {
      userAssignedResourceIds: [
        userAssignedIdentity.outputs.resourceId
      ]
    }
    kind: 'AzurePowerShell'
    baseTime: utcValue
    azPowerShellVersion: '12.3'
    environmentVariables: [
      {
        name: 'varResourceGroupName'
        value: resourceGroupName
      }
      {
        name: 'varScriptName'
        value: scriptName
      }
    ]
    scriptContent: '''
    Remove-AzDeploymentScript -ResourceGroupName $env:varResourceGroupName -Name $env:varScriptName
    '''
    timeout: 'PT1H'
    retentionInterval: 'PT1H'
  }
}
```

**PowerShell Content Explanation:**

```powershell
Remove-AzDeploymentScript -ResourceGroupName $env:varResourceGroupName -Name $env:varScriptName
```

- **Delete Deployment Script**: The script removes the deployment script that generated the secret, ensuring that the script and its outputs are deleted after 1 hour.

**Example deployment usage:**

- Use the following inside or outside of the same script using the existing keyvault resource

```bicep
adminPassword: keyVaultExisting.getSecret(secretName)
```

```bicep

// Example Usage of the keyvault secret for VM deployment can be used outside or inside the same bicep file

@description('This is where we are using and an existing Keyvault for VM deployment')
resource keyVaultExisting 'Microsoft.KeyVault/vaults@2019-09-01' existing = {
  name: keyVaultName
  scope: sharedResourceGroup
}

@description('Example usage of the keyvault secret for VM deployment')
module virtualMachine 'br/public:avm/res/compute/virtual-machine:0.11.0' = {
  name: 'virtualMachineDeployment'
  scope: sharedResourceGroup
  params: {
    // Required parameters
    adminUsername: 'localAdminUser'
    // Call the keyvault secret based on the secretName and existing keyvault resource. 
    adminPassword: keyVaultExisting.getSecret(secretName)
    imageReference: {
      offer: 'WindowsServer'
      publisher: 'MicrosoftWindowsServer'
      sku: '2022-datacenter-azure-edition'
      version: 'latest'
    }
    name: 'cvmwinmin'
    nicConfigurations: [
      {
        ipConfigurations: [
          {
            name: 'ipconfig01'
            subnetResourceId: '<subnetResourceId>'
          }
        ]
        nicSuffix: '-nic-01'
      }
    ]
    osDisk: {
      caching: 'ReadWrite'
      diskSizeGB: 128
      managedDisk: {
        storageAccountType: 'Premium_LRS'
      }
    }
    osType: 'Windows'
    vmSize: 'Standard_D2s_v3'
    zone: 0
  }
}
```

### How to Use
1. **Deploy the Script**: Deploy the Bicep script to your Azure subscription.
2. **Generate Secret**: The deployment script

### Deployment script

- Add the following to your .ps1 deployment script and run the file .\deploy.ps1 with optional -WhatIf

```powershell
# Required. Set the location for the deployment
$location = "<required>"

# Variables
$templateFile = 'main.bicep'
$today = Get-Date -Format 'MM-dd-yyyy'
$deploymentName = "deploymentscript-$today"

# Deploy the Bicep template
New-AzDeployment -Name $deploymentName `
    -Location $location `
    -TemplateFile $templateFile `
    -Verbose #-WhatIf
```